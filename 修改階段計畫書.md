# Archive-Compress.sh 修改階段計畫書

## 🎯 專案目標
將現有的 `archive-compress.sh` (原 `rezip.sh`) 腳本升級，使其符合企劃書中的冷儲存封存 SOP 要求，同時保留 7z 轉換功能。

## 📈 進度概覽
**已完成階段**：1, 2, 2.5, 3, 4, 5, 6, 7, 8, 9 (10/10 = **100% 完成**) ✅  
**當前階段**：專案完成  
**下一里程碑**：專案已完整結束，具備生產環境完整功能

---

## 📋 修改階段清單

### 🔍 **階段1：工具檢查與環境準備**
- [x] 新增 `b3sum` (BLAKE3) 工具檢查
- [x] 新增 `par2cmdline` (PAR2 修復) 工具檢查  
- [x] 移除 `gnupg` 檢查（個人用途不需要 GPG 簽章）
- [x] 更新工具安裝說明和錯誤訊息
- [x] 測試所有工具的可用性檢查

### ⚙️ **階段2：Deterministic Tar 參數調整** 
- [x] 加入 `--sort=name` 參數（檔案名稱排序）
- [x] ~~加入 `--mtime='UTC 2025-01-01'` 參數~~（不使用，保留原始時間戳）
- [x] ~~加入 `--owner=0 --group=0 --numeric-owner` 參數~~（不使用，保留原始所有者）
- [x] 確保 tar 創建的可重現性（透過檔案排序）
- [x] 測試 deterministic tar 功能

### 🔧 **階段2.5：Tar 與 Zstd 分離重構**
- [x] 重構 `compress_to_tar_zst()` 函數，採用分離模式而非管道模式
- [x] 實作分階段處理：tar 創建 → tar 驗證 → zstd 壓縮 → 清理
- [x] 新增中間 tar 檔案驗證步驟（`tar -tvf exp42.tar > /dev/null`）
- [x] 實作安全的臨時檔案管理機制（創建、驗證、清理）
- [x] 加入分階段錯誤處理和詳細報告
- [x] 新增磁碟空間預檢機制（確保有足夠空間存放臨時檔案）
- [x] 驗證與企劃書 SOP 流程的完全一致性
- [x] 實作企劃書步驟4的立即驗證（zstd完整性 + tar內容雙重驗證）

### 🗜️ **階段3：Zstd 壓縮參數優化**
- [x] 將 `--long` 改為 `--long=31`（2GB dictionary window）
- [x] 根據企劃書調整預設壓縮等級建議（保持 -19 等級）
- [x] 更新參數說明文件
- [x] 保持大檔案支援能力
- [x] 測試壓縮參數效果

### 🔐 **階段4：雙雜湊支援 (SHA-256 + BLAKE3)**
- [x] 保留現有 SHA-256 功能
- [x] 新增 BLAKE3 雜湊產生函數
- [x] 新增 BLAKE3 雜湊驗證函數  
- [x] 修改校驗流程支援雙重驗證
- [x] 更新輸出檔案命名格式
- [x] 修正函數輸出重定向問題
- [x] 測試雙雜湊功能

### 🛡️ **階段5：PAR2 修復冗餘**
- [x] 新增 PAR2 10% 修復冗餘產生功能
- [x] 新增 PAR2 驗證機制
- [x] 整合 PAR2 到主要處理流程
- [x] 加入 PAR2 錯誤處理
- [x] 測試 PAR2 修復功能
- [x] 實作簡化輸出方案（-n1 參數，2個PAR2檔案而非9個）
- [x] 修正 PAR2 大小統計邏輯（正確計算總冗餘大小）

### 🔬 **階段6：強化驗證流程**
- [x] 實作 tar header 驗證（步驟2）**已在階段2.5完成**
- [x] 實作 zstd 完整性驗證（步驟4）**已在階段2.5完成**
- [x] 實作解壓縮後 tar 內容驗證（步驟4）**已在階段2.5完成**
- [x] 整合雙雜湊驗證流程 **已在階段4-5完成**
- [x] 整合 PAR2 驗證流程 **已在階段5完成**
- [x] 加入詳細的錯誤報告機制 **已在階段2.5完成**
- [x] 完善驗證流程的錯誤處理和報告格式
- [x] 加入驗證失敗時的詳細診斷資訊
- [x] 實作驗證統計和性能監控

### 📊 **階段7：輸出格式與日誌優化** 
- [x] 調整輸出檔案命名符合企劃書格式
- [x] 優化各階段的日誌輸出
- [x] 加入處理時間統計
- [x] 加入壓縮效率統計
- [x] 改善進度顯示和用戶體驗

### 🧪 **階段8：整合測試與文件更新**
- [x] 端到端功能測試
- [x] 邊界條件測試（大檔案、特殊字元等）
- [x] 錯誤情況測試
- [x] 更新腳本內部文件和註解
- [x] 更新使用說明

### 📁 **階段9：檔案組織與目錄結構優化**
- [x] 實作子目錄組織方案（每個7z檔案對應一個子目錄）
- [x] 新增 `--output-dir` 參數指定輸出目錄
- [x] 新增 `--flat` 參數保持扁平結構（向後相容）
- [x] 實作目錄清理和整理功能
- [x] 更新統計顯示以支援目錄結構
- [x] 測試目錄權限和創建邏輯
- [x] 簡化參數設計，移除衝突選項

### 🔧 **補充計畫：輔助工具腳本開發**
- [x] **完整性檢查腳本 (`verify-archive.sh`)**
  - [x] 實作 tar.zst 檔案完整性檢查
  - [x] 自動偵測相關檔案（.sha256, .blake3, .par2）
  - [x] 執行雙重雜湊驗證（SHA-256 + BLAKE3）
  - [x] 執行 PAR2 冗餘完整性檢查
  - [x] 執行 zstd 完整性檢查
  - [x] 提供詳細的檢查報告和錯誤診斷
  - [x] 支援批量檢查功能

- [x] **解壓縮腳本 (`extract-archive.sh`)**
  - [x] 實作 tar.zst 檔案兩階段解壓縮功能（zstd + tar）
  - [x] 自動偵測並使用正確的 zstd 參數（--long=31）
  - [x] 執行解壓縮前完整性檢查
  - [x] 提供安全的目標目錄創建
  - [x] 支援檔案覆蓋保護機制
  - [x] 提供解壓縮進度和統計資訊
  - [x] 與 rezip.sh 參數保持一致性

---

## 📂 檔案組織結構（階段9新增）

### 子目錄組織方案（預設）
```
work_directory/
├── file1.7z                           # 原始檔案
├── file2.7z                           # 原始檔案  
└── processed/                         # 輸出目錄
    ├── file1/                         # 每個7z檔案的子目錄
    │   ├── file1.tar.zst              # 主檔
    │   ├── file1.tar.zst.sha256       # SHA-256雜湊
    │   ├── file1.tar.zst.blake3       # BLAKE3雜湊
    │   ├── file1.tar.zst.par2         # PAR2主檔案
    │   └── file1.tar.zst.vol000+200.par2  # PAR2修復檔案
    └── file2/                         # 第二個檔案的子目錄
        ├── file2.tar.zst
        └── ...
```

### 扁平結構（向後相容）
```
work_directory/
├── file1.7z                          # 原始檔案
├── file1.tar.zst                     # 處理後檔案
├── file1.tar.zst.sha256
├── file1.tar.zst.blake3  
├── file1.tar.zst.par2
├── file1.tar.zst.vol000+200.par2
└── ...
```

### 目錄參數
- `--output-dir DIR`：指定輸出目錄（預設：`./processed`）
- `--flat`：使用扁平結構（向後相容，不創建子目錄）
- 預設行為：子目錄組織（推薦方式，避免檔案混亂）

---

## 📁 預期輸出檔案格式

根據企劃書，每個處理完的檔案應產生：

```
exp42.tar.zst                    # 主檔（壓縮流含 32-bit checksum）
exp42.tar.zst.sha256             # SHA-256 雜湊
exp42.tar.zst.blake3             # BLAKE3 雜湊  
exp42.tar.zst.par2               # PAR2 主檔案（檔案資訊）
exp42.tar.zst.vol000+200.par2    # PAR2 修復檔案（10% 冗餘，簡化方案）
```

**說明**：
- **簡化 PAR2 輸出**：使用 `-n1` 參數，產生 2 個 PAR2 檔案而非傳統的 9 個分層檔案
- **總檔案數量**：每個 7z 檔案產生 5 個輸出檔案（原企劃書為 4 個，實際為 5 個）

---

## 🔧 技術重點

### Deterministic Tar 參數（分離模式）
```bash
# 步驟1：創建 deterministic tar
tar --sort=name \
    --format=posix \
    -cf archive.tar directory/

# 步驟2：驗證 tar header
tar -tvf archive.tar > /dev/null
```
**注意**：保留原始時間戳和所有者資訊，僅確保檔案順序一致性

### Zstd 最佳化參數（分離模式）
```bash
# 步驟3：壓縮 tar 檔案
zstd -T0 -19 --long=31 --check archive.tar -o archive.tar.zst

# 步驟4：清理臨時檔案
rm archive.tar
```
**說明**：
- `-T0`: 使用所有可用 CPU 核心
- `-19`: 高壓縮等級，平衡壓縮比和速度
- `--long=31`: 2GB dictionary window，用於大檔案優化，壓縮率提升 3-10%
- `--check`: 內建完整性檢查

### Tar-Zstd 分離模式優勢
- **分階段驗證**：可立即檢查 tar header 正確性
- **除錯友善**：可檢查中間檔案，問題定位容易
- **可重製性**：tar 檔案便於 binary diff 和重用
- **符合企劃書 SOP**：遵循冷儲存標準流程

### PAR2 修復冗餘參數
```bash
par2 create -r10 -n1 -q archive.tar.zst
```
**說明**：
- `-r10`: 10% 修復冗餘
- `-n1`: 限制為 1 個修復檔案（簡化輸出）
- `-q`: 安靜模式，減少輸出

### 驗證流程順序（分離模式）
1. **tar header 驗證**：`tar -tvf archive.tar > /dev/null` ✅ 
2. **zstd 完整性驗證**：`zstd -tq --long=31 archive.tar.zst` **(修正：需要記憶體參數)**
3. **解壓縮內容驗證**：`zstd -dc --long=31 archive.tar.zst | tar -tvf - > /dev/null` **(修正：需要記憶體參數)**
4. **雜湊驗證**：`sha256sum -c` + `b3sum -c`
5. **PAR2 修復驗證**：`par2 verify archive.tar.zst.par2`

**重要改進**：
- 分離模式使步驟1成為可能，提供早期錯誤偵測
- **階段2.5修正**：驗證時必須使用與壓縮一致的記憶體參數

---

## 💡 開發注意事項

- 保持向後相容性
- 維持良好的錯誤處理機制
- 確保所有臨時檔案都能正確清理
- 提供詳細的進度回饋給用戶
- 測試各種檔案大小和複雜度情況

### 📝 階段5實作經驗
- **PAR2輸出重定向**：需要正確使用 `>&2` 避免污染函數返回值
- **簡化vs分層**：冷儲存場景更適合簡化方案（`-n1`），減少檔案管理複雜度
- **統計計算**：PAR2總大小需要包含主檔案和所有.vol修復檔案
- **退出碼驗證**：PAR2驗證以退出碼為準，而非輸出內容解析

### 📝 階段2.5實作經驗
- **分離模式優勢**：實現了企劃書的5階段處理流程，提供早期錯誤偵測
- **磁碟空間管理**：新增預檢機制，避免處理過程中空間不足
- **臨時檔案安全**：完整的創建→驗證→清理流程，防止殘留檔案
- **分階段日誌**：詳細的階段進度報告，便於問題診斷
- **雙重驗證**：實作企劃書步驟4的完整性驗證（zstd + tar內容）
- **錯誤處理**：每階段獨立錯誤處理，失敗時自動清理臨時檔案
- **記憶體參數一致性**：關鍵修正 - 驗證時必須使用與壓縮相同的記憶體參數（`--long=31`）
- **性能表現**：實測4.19GB→1.65GB（39.29%），PAR2冗餘精確控制在10.02%
- **企劃書完全一致**：100%符合企劃書第6.3節分離模式要求

### 📝 階段6實作經驗
- **驗證統計系統**：新增 `verification_stats()` 函數，記錄每個驗證步驟的耗時和處理速度
- **診斷資訊系統**：實作 `generate_diagnostic_info()` 函數，提供錯誤類型、系統資源、檔案狀態等詳細診斷
- **強化錯誤處理**：改善所有驗證函數的錯誤訊息格式，提供結構化的問題診斷
- **性能監控**：加入處理時間統計和速度計算，包含檔案級別和步驟級別的性能數據
- **診斷範圍**：涵蓋磁碟空間、記憶體狀況、檔案權限、工具版本等多維度診斷
- **用戶體驗**：失敗時提供可操作的建議，成功時顯示詳細的處理統計
- **統計精度**：使用毫秒級別時間戳記（%s.%3N），提供精確的性能分析

### 📝 階段7實作經驗
- **美化統計輸出**：新增 `display_file_statistics()` 函數，使用表格化格式展示檔案處理結果
- **智能檔案大小格式化**：實作 `format_file_size()` 函數，自動選擇合適的單位（B/KB/MB/GB）
- **時間格式化優化**：新增 `format_duration()` 函數，支持小時/分鐘/秒的智能格式化
- **批次摘要報告**：實作 `display_final_summary()` 函數，提供完整的批次處理統計
- **檔案清單展示**：在統計中顯示所有生成檔案的詳細信息和大小
- **進度條美化**：使用 Unicode 字符（█ 和 ░）創建更美觀的進度條
- **企劃書符合性檢查**：在最終摘要中顯示所有 SOP 要求的完成狀態
- **用戶體驗提升**：統一的分隔線、表格化布局、彩色輸出等視覺優化
- **成功率統計**：計算並顯示批次處理的成功率和平均處理時間
- **結構化輸出**：所有統計信息使用一致的表格格式，便於閱讀和理解

### 📝 階段8實作經驗
- **整合測試完成**：驗證所有功能模組的協同工作，確保端到端流程穩定
- **大檔案測試**：通過 4GB+ 檔案測試，驗證 POSIX tar 格式和 zstd --long=31 參數的效能
- **邊界條件處理**：強化對特殊檔名、空目錄、權限問題等邊界情況的處理能力
- **錯誤恢復機制**：完善各階段的錯誤處理，實現優雅的失敗恢復和清理機制
- **文件完整性**：更新所有函數註解，提供清晰的參數說明和使用範例
- **使用說明優化**：豐富 help 訊息，包含記憶體需求、工具依賴和最佳實踐建議
- **性能監控**：實作詳細的處理時間統計和資源使用監控
- **生產就緒**：腳本已達到生產環境使用標準，具備完整的冷儲存 SOP 功能

### 📝 階段9實作經驗
- **子目錄組織系統**：實作 `setup_output_directory()` 函數，支援每個7z檔案對應專屬子目錄
- **簡潔參數設計**：新增 `--output-dir`, `--flat` 參數，避免互斥選項衝突
- **向後相容性**：`--flat` 參數確保與舊版腳本行為完全相容
- **智能預設行為**：預設使用子目錄組織，提供更好的檔案管理體驗
- **智能路徑處理**：支援絕對路徑和相對路徑的輸出目錄指定
- **目錄權限管理**：完整的目錄創建、權限檢查和失敗清理機制
- **統計顯示增強**：更新 `display_file_statistics()` 函數，顯示檔案組織資訊
- **錯誤處理優化**：失敗時自動清理空目錄，避免殘留垃圾目錄
- **用戶體驗提升**：處理設定中清楚顯示檔案組織模式和輸出路徑
- **生產環境友好**：預設子目錄組織避免檔案混亂，適合大量檔案處理

---

---

## 🛠️ 輔助工具腳本說明

### 完整性檢查腳本 (`verify-archive.sh`)
冷儲存封存檔案的全面驗證工具，執行五項關鍵檢查：

```bash
# 基本使用
./verify-archive.sh archive.tar.zst
./verify-archive.sh -d ./processed        # 批量檢查
./verify-archive.sh -v archive.tar.zst    # 詳細模式
```

**驗證項目**：
1. **zstd 完整性檢查**：使用 `zstd -tq --long=31` 驗證壓縮檔案完整性
2. **SHA-256 雜湊驗證**：檢查 `.sha256` 檔案並計算實際雜湊值
3. **BLAKE3 雜湊驗證**：檢查 `.blake3` 檔案並計算實際雜湊值
4. **PAR2 冗餘檢查**：使用 `par2 verify` 檢查修復檔案完整性
5. **tar 內容驗證**：解壓縮並驗證 tar 檔案結構

**特色功能**：
- 智能檔案偵測（自動尋找相關驗證檔案）
- 批量處理支援（目錄掃描）
- 詳細診斷報告（包含修復建議）
- 彩色輸出和進度顯示
- 完整的統計摘要

### 解壓縮腳本 (`extract-archive.sh`)
安全的 tar.zst 檔案解壓縮工具，提供兩階段解壓縮：

```bash
# 基本使用
./extract-archive.sh archive.tar.zst              # 解壓縮到 ./archive/
./extract-archive.sh -o /path/to/output archive.tar.zst  # 指定輸出目錄
./extract-archive.sh -f archive.tar.zst           # 強制覆蓋模式
```

**解壓縮流程**：
1. **完整性檢查**：自動呼叫 `verify-archive.sh` 進行預檢
2. **目標目錄準備**：安全創建輸出目錄，避免覆蓋風險
3. **兩階段解壓縮**：`zstd -dc --long=31 | tar -xf -C OUTPUT_DIR`
4. **解壓縮後驗證**：檢查檔案數量和總大小
5. **統計報告**：顯示壓縮比、檔案數量、處理時間

**安全特性**：
- 預設完整性檢查（可用 `--no-check` 跳過）
- 覆蓋保護機制（需 `--force` 才能覆蓋）
- 自動參數匹配（使用與壓縮相同的 zstd 參數）
- 詳細錯誤診斷和恢復建議
- 處理進度和性能統計

**技術一致性**：
- 使用相同的 `--long=31` 參數確保解壓縮相容性
- 支援與 `archive-compress.sh` 完全相同的檔案格式
- 相同的日誌系統和錯誤處理機制
- 統一的使用者介面設計

### 工具整合使用建議
1. **壓縮流程**：`archive-compress.sh` → 產生 tar.zst 及驗證檔案
2. **驗證流程**：`verify-archive.sh` → 定期檢查檔案完整性
3. **解壓縮流程**：`extract-archive.sh` → 安全恢復檔案內容

這三個腳本形成完整的冷儲存檔案生命週期管理工具鏈，確保資料的安全性、完整性和可恢復性。

---

*最後更新：2025年1月16日 - 補充計畫完成：輔助工具腳本開發，專案全面完成（進度100%）* 