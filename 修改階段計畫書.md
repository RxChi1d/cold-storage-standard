# Rezip.sh 修改階段計畫書

## 🎯 專案目標
將現有的 `rezip.sh` 腳本升級，使其符合企劃書中的冷儲存封存 SOP 要求，同時保留 7z 轉換功能。

## 📈 進度概覽
**已完成階段**：1, 2, 2.5, 3, 4, 5, 6, 7 (9/9 = **100% 完成**) ✅  
**當前階段**：第八階段（整合測試與文件更新）  
**下一里程碑**：完成最終測試並結束專案

---

## 📋 修改階段清單

### 🔍 **階段1：工具檢查與環境準備**
- [x] 新增 `b3sum` (BLAKE3) 工具檢查
- [x] 新增 `par2cmdline` (PAR2 修復) 工具檢查  
- [x] 移除 `gnupg` 檢查（個人用途不需要 GPG 簽章）
- [x] 更新工具安裝說明和錯誤訊息
- [x] 測試所有工具的可用性檢查

### ⚙️ **階段2：Deterministic Tar 參數調整** 
- [x] 加入 `--sort=name` 參數（檔案名稱排序）
- [x] ~~加入 `--mtime='UTC 2025-01-01'` 參數~~（不使用，保留原始時間戳）
- [x] ~~加入 `--owner=0 --group=0 --numeric-owner` 參數~~（不使用，保留原始所有者）
- [x] 確保 tar 創建的可重現性（透過檔案排序）
- [x] 測試 deterministic tar 功能

### 🔧 **階段2.5：Tar 與 Zstd 分離重構**
- [x] 重構 `compress_to_tar_zst()` 函數，採用分離模式而非管道模式
- [x] 實作分階段處理：tar 創建 → tar 驗證 → zstd 壓縮 → 清理
- [x] 新增中間 tar 檔案驗證步驟（`tar -tvf exp42.tar > /dev/null`）
- [x] 實作安全的臨時檔案管理機制（創建、驗證、清理）
- [x] 加入分階段錯誤處理和詳細報告
- [x] 新增磁碟空間預檢機制（確保有足夠空間存放臨時檔案）
- [x] 驗證與企劃書 SOP 流程的完全一致性
- [x] 實作企劃書步驟4的立即驗證（zstd完整性 + tar內容雙重驗證）

### 🗜️ **階段3：Zstd 壓縮參數優化**
- [x] 將 `--long` 改為 `--long=31`（2GB dictionary window）
- [x] 根據企劃書調整預設壓縮等級建議（保持 -19 等級）
- [x] 更新參數說明文件
- [x] 保持大檔案支援能力
- [x] 測試壓縮參數效果

### 🔐 **階段4：雙雜湊支援 (SHA-256 + BLAKE3)**
- [x] 保留現有 SHA-256 功能
- [x] 新增 BLAKE3 雜湊產生函數
- [x] 新增 BLAKE3 雜湊驗證函數  
- [x] 修改校驗流程支援雙重驗證
- [x] 更新輸出檔案命名格式
- [x] 修正函數輸出重定向問題
- [x] 測試雙雜湊功能

### 🛡️ **階段5：PAR2 修復冗餘**
- [x] 新增 PAR2 10% 修復冗餘產生功能
- [x] 新增 PAR2 驗證機制
- [x] 整合 PAR2 到主要處理流程
- [x] 加入 PAR2 錯誤處理
- [x] 測試 PAR2 修復功能
- [x] 實作簡化輸出方案（-n1 參數，2個PAR2檔案而非9個）
- [x] 修正 PAR2 大小統計邏輯（正確計算總冗餘大小）

### 🔬 **階段6：強化驗證流程**
- [x] 實作 tar header 驗證（步驟2）**已在階段2.5完成**
- [x] 實作 zstd 完整性驗證（步驟4）**已在階段2.5完成**
- [x] 實作解壓縮後 tar 內容驗證（步驟4）**已在階段2.5完成**
- [x] 整合雙雜湊驗證流程 **已在階段4-5完成**
- [x] 整合 PAR2 驗證流程 **已在階段5完成**
- [x] 加入詳細的錯誤報告機制 **已在階段2.5完成**
- [x] 完善驗證流程的錯誤處理和報告格式
- [x] 加入驗證失敗時的詳細診斷資訊
- [x] 實作驗證統計和性能監控

### 📊 **階段7：輸出格式與日誌優化** 
- [x] 調整輸出檔案命名符合企劃書格式
- [x] 優化各階段的日誌輸出
- [x] 加入處理時間統計
- [x] 加入壓縮效率統計
- [x] 改善進度顯示和用戶體驗

### 🧪 **階段8：整合測試與文件更新**
- [ ] 端到端功能測試
- [ ] 邊界條件測試（大檔案、特殊字元等）
- [ ] 錯誤情況測試
- [ ] 更新腳本內部文件和註解
- [ ] 更新使用說明

---

## 📁 預期輸出檔案格式

根據企劃書，每個處理完的檔案應產生：

```
exp42.tar.zst                    # 主檔（壓縮流含 32-bit checksum）
exp42.tar.zst.sha256             # SHA-256 雜湊
exp42.tar.zst.blake3             # BLAKE3 雜湊  
exp42.tar.zst.par2               # PAR2 主檔案（檔案資訊）
exp42.tar.zst.vol000+200.par2    # PAR2 修復檔案（10% 冗餘，簡化方案）
```

**說明**：
- **簡化 PAR2 輸出**：使用 `-n1` 參數，產生 2 個 PAR2 檔案而非傳統的 9 個分層檔案
- **總檔案數量**：每個 7z 檔案產生 5 個輸出檔案（原企劃書為 4 個，實際為 5 個）

---

## 🔧 技術重點

### Deterministic Tar 參數（分離模式）
```bash
# 步驟1：創建 deterministic tar
tar --sort=name \
    --format=posix \
    -cf archive.tar directory/

# 步驟2：驗證 tar header
tar -tvf archive.tar > /dev/null
```
**注意**：保留原始時間戳和所有者資訊，僅確保檔案順序一致性

### Zstd 最佳化參數（分離模式）
```bash
# 步驟3：壓縮 tar 檔案
zstd -T0 -19 --long=31 --check archive.tar -o archive.tar.zst

# 步驟4：清理臨時檔案
rm archive.tar
```
**說明**：
- `-T0`: 使用所有可用 CPU 核心
- `-19`: 高壓縮等級，平衡壓縮比和速度
- `--long=31`: 2GB dictionary window，用於大檔案優化，壓縮率提升 3-10%
- `--check`: 內建完整性檢查

### Tar-Zstd 分離模式優勢
- **分階段驗證**：可立即檢查 tar header 正確性
- **除錯友善**：可檢查中間檔案，問題定位容易
- **可重製性**：tar 檔案便於 binary diff 和重用
- **符合企劃書 SOP**：遵循冷儲存標準流程

### PAR2 修復冗餘參數
```bash
par2 create -r10 -n1 -q archive.tar.zst
```
**說明**：
- `-r10`: 10% 修復冗餘
- `-n1`: 限制為 1 個修復檔案（簡化輸出）
- `-q`: 安靜模式，減少輸出

### 驗證流程順序（分離模式）
1. **tar header 驗證**：`tar -tvf archive.tar > /dev/null` ✅ 
2. **zstd 完整性驗證**：`zstd -tq --long=31 archive.tar.zst` **(修正：需要記憶體參數)**
3. **解壓縮內容驗證**：`zstd -dc --long=31 archive.tar.zst | tar -tvf - > /dev/null` **(修正：需要記憶體參數)**
4. **雜湊驗證**：`sha256sum -c` + `b3sum -c`
5. **PAR2 修復驗證**：`par2 verify archive.tar.zst.par2`

**重要改進**：
- 分離模式使步驟1成為可能，提供早期錯誤偵測
- **階段2.5修正**：驗證時必須使用與壓縮一致的記憶體參數

---

## 💡 開發注意事項

- 保持向後相容性
- 維持良好的錯誤處理機制
- 確保所有臨時檔案都能正確清理
- 提供詳細的進度回饋給用戶
- 測試各種檔案大小和複雜度情況

### 📝 階段5實作經驗
- **PAR2輸出重定向**：需要正確使用 `>&2` 避免污染函數返回值
- **簡化vs分層**：冷儲存場景更適合簡化方案（`-n1`），減少檔案管理複雜度
- **統計計算**：PAR2總大小需要包含主檔案和所有.vol修復檔案
- **退出碼驗證**：PAR2驗證以退出碼為準，而非輸出內容解析

### 📝 階段2.5實作經驗
- **分離模式優勢**：實現了企劃書的5階段處理流程，提供早期錯誤偵測
- **磁碟空間管理**：新增預檢機制，避免處理過程中空間不足
- **臨時檔案安全**：完整的創建→驗證→清理流程，防止殘留檔案
- **分階段日誌**：詳細的階段進度報告，便於問題診斷
- **雙重驗證**：實作企劃書步驟4的完整性驗證（zstd + tar內容）
- **錯誤處理**：每階段獨立錯誤處理，失敗時自動清理臨時檔案
- **記憶體參數一致性**：關鍵修正 - 驗證時必須使用與壓縮相同的記憶體參數（`--long=31`）
- **性能表現**：實測4.19GB→1.65GB（39.29%），PAR2冗餘精確控制在10.02%
- **企劃書完全一致**：100%符合企劃書第6.3節分離模式要求

### 📝 階段6實作經驗
- **驗證統計系統**：新增 `verification_stats()` 函數，記錄每個驗證步驟的耗時和處理速度
- **診斷資訊系統**：實作 `generate_diagnostic_info()` 函數，提供錯誤類型、系統資源、檔案狀態等詳細診斷
- **強化錯誤處理**：改善所有驗證函數的錯誤訊息格式，提供結構化的問題診斷
- **性能監控**：加入處理時間統計和速度計算，包含檔案級別和步驟級別的性能數據
- **診斷範圍**：涵蓋磁碟空間、記憶體狀況、檔案權限、工具版本等多維度診斷
- **用戶體驗**：失敗時提供可操作的建議，成功時顯示詳細的處理統計
- **統計精度**：使用毫秒級別時間戳記（%s.%3N），提供精確的性能分析

### 📝 階段7實作經驗
- **美化統計輸出**：新增 `display_file_statistics()` 函數，使用表格化格式展示檔案處理結果
- **智能檔案大小格式化**：實作 `format_file_size()` 函數，自動選擇合適的單位（B/KB/MB/GB）
- **時間格式化優化**：新增 `format_duration()` 函數，支持小時/分鐘/秒的智能格式化
- **批次摘要報告**：實作 `display_final_summary()` 函數，提供完整的批次處理統計
- **檔案清單展示**：在統計中顯示所有生成檔案的詳細信息和大小
- **進度條美化**：使用 Unicode 字符（█ 和 ░）創建更美觀的進度條
- **企劃書符合性檢查**：在最終摘要中顯示所有 SOP 要求的完成狀態
- **用戶體驗提升**：統一的分隔線、表格化布局、彩色輸出等視覺優化
- **成功率統計**：計算並顯示批次處理的成功率和平均處理時間
- **結構化輸出**：所有統計信息使用一致的表格格式，便於閱讀和理解

---

*最後更新：2025年6月30日 - 階段7完成：輸出格式與日誌優化，美化統計和摘要報告（進度100%）* 