# Rezip.sh 修改階段計畫書

## 🎯 專案目標
將現有的 `rezip.sh` 腳本升級，使其符合企劃書中的冷儲存封存 SOP 要求，同時保留 7z 轉換功能。

---

## 📋 修改階段清單

### 🔍 **階段1：工具檢查與環境準備**
- [x] 新增 `b3sum` (BLAKE3) 工具檢查
- [x] 新增 `par2cmdline` (PAR2 修復) 工具檢查  
- [x] 移除 `gnupg` 檢查（個人用途不需要 GPG 簽章）
- [x] 更新工具安裝說明和錯誤訊息
- [x] 測試所有工具的可用性檢查

### ⚙️ **階段2：Deterministic Tar 參數調整** 
- [x] 加入 `--sort=name` 參數（檔案名稱排序）
- [x] ~~加入 `--mtime='UTC 2025-01-01'` 參數~~（不使用，保留原始時間戳）
- [x] ~~加入 `--owner=0 --group=0 --numeric-owner` 參數~~（不使用，保留原始所有者）
- [x] 確保 tar 創建的可重現性（透過檔案排序）
- [x] 測試 deterministic tar 功能

### 🗜️ **階段3：Zstd 壓縮參數優化**
- [x] 將 `--long` 改為 `--long=31`（2GB dictionary window）
- [x] 根據企劃書調整預設壓縮等級建議（保持 -19 等級）
- [x] 更新參數說明文件
- [x] 保持大檔案支援能力
- [x] 測試壓縮參數效果

### 🔐 **階段4：雙雜湊支援 (SHA-256 + BLAKE3)**
- [x] 保留現有 SHA-256 功能
- [x] 新增 BLAKE3 雜湊產生函數
- [x] 新增 BLAKE3 雜湊驗證函數  
- [x] 修改校驗流程支援雙重驗證
- [x] 更新輸出檔案命名格式
- [x] 修正函數輸出重定向問題
- [x] 測試雙雜湊功能

### 🛡️ **階段5：PAR2 修復冗餘**
- [ ] 新增 PAR2 10% 修復冗餘產生功能
- [ ] 新增 PAR2 驗證機制
- [ ] 整合 PAR2 到主要處理流程
- [ ] 加入 PAR2 錯誤處理
- [ ] 測試 PAR2 修復功能

### 🔬 **階段6：強化驗證流程**
- [ ] 實作 tar header 驗證（步驟2）
- [ ] 實作 zstd 完整性驗證（步驟4）
- [ ] 實作解壓縮後 tar 內容驗證（步驟4）
- [ ] 整合雙雜湊驗證流程
- [ ] 整合 PAR2 驗證流程
- [ ] 加入詳細的錯誤報告機制

### 📊 **階段7：輸出格式與日誌優化** 
- [ ] 調整輸出檔案命名符合企劃書格式
- [ ] 優化各階段的日誌輸出
- [ ] 加入處理時間統計
- [ ] 加入壓縮效率統計
- [ ] 改善進度顯示和用戶體驗

### 🧪 **階段8：整合測試與文件更新**
- [ ] 端到端功能測試
- [ ] 邊界條件測試（大檔案、特殊字元等）
- [ ] 錯誤情況測試
- [ ] 更新腳本內部文件和註解
- [ ] 更新使用說明

---

## 📁 預期輸出檔案格式

根據企劃書，每個處理完的檔案應產生：

```
exp42.tar.zst              # 主檔（壓縮流含 32-bit checksum）
exp42.tar.zst.sha256       # SHA-256 雜湊
exp42.tar.zst.blake3       # BLAKE3 雜湊  
exp42.tar.zst.par2         # 10% 修復冗餘
```

---

## 🔧 技術重點

### Deterministic Tar 參數
```bash
tar --sort=name \
    --format=posix \
    -cf archive.tar directory/
```
**注意**：保留原始時間戳和所有者資訊，僅確保檔案順序一致性

### Zstd 最佳化參數
```bash
zstd -T0 -19 --long=31 --check archive.tar -o archive.tar.zst
```
**說明**：
- `-T0`: 使用所有可用 CPU 核心
- `-19`: 高壓縮等級，平衡壓縮比和速度
- `--long=31`: 2GB dictionary window，用於大檔案優化，壓縮率提升 3-10%
- `--check`: 內建完整性檢查

### 驗證流程順序
1. ~~tar header 驗證：`tar -tvf archive.tar > /dev/null`~~ (管道模式下不適用)
2. zstd 完整性：`zstd -tq archive.tar.zst`  
3. 內容驗證：`zstd -dc archive.tar.zst | tar -tvf - > /dev/null`
4. 雜湊驗證：`sha256sum -c` + `b3sum -c`
5. PAR2 驗證：`par2 verify`

---

## 💡 開發注意事項

- 保持向後相容性
- 維持良好的錯誤處理機制
- 確保所有臨時檔案都能正確清理
- 提供詳細的進度回饋給用戶
- 測試各種檔案大小和複雜度情況

---

*最後更新：{{ 當前日期 }}* 