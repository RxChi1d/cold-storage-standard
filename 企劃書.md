## 冷儲存封存 SOP — 技術細節版 (tar + zstd)

### 1 企劃目標

| 目標          | 說明                                                             |
| ----------- | -------------------------------------------------------------- |
| **Primary** | 產生可長期保存、可驗證、可修復的單一封存檔 (`expXX.tar.zst`)                        |
| **Scope**   | 僅討論：產生 `tar` → 壓縮 → 雜湊 / 簽章 → PAR2 冗餘 → 驗證；**不涵蓋** 儲存位置或後續搬遷機制 |

---

### 2 範圍與前置條件

* **輸入**：單一實驗資料夾 (`/data/exp42/`)，大小 4–10 GB。
* **輸出**：

  * `exp42.tar.zst`　　主檔 (壓縮流含 32‑bit checksum)
  * `exp42.tar.zst.sha256`／`exp42.tar.zst.blake3`　雙雜湊
  * `exp42.tar.zst.par2`　10 % 修復冗餘
  * `exp42.tar.zst.sha256.asc` (可選)　雜湊檔 GPG 簽章

---

### 3 必要套件 (Ubuntu 22.04)

| 套件               | 版本 / 備註            |
| ---------------- | ------------------ |
| **tar**          | 1.34+ (內建 zstd 支援) |
| **zstd**         | 1.5+               |
| **par2cmdline**  | 用於 PAR2 冗餘         |
| **gnupg**        | GPG 簽章與加密          |
| **b3sum**        | BLAKE3 雜湊          |
| **rsync**        | 傳輸時使用 `--checksum` |
| *可選* `mailutils` | 供 cron 重驗失敗時寄信通知   |

```bash
sudo apt update && sudo apt install tar zstd par2cmdline gnupg b3sum rsync mailutils
```

---

### 4 流程 Canvas

```
┌──────────────────────────────────────────────────┐
│ ① 產生 tar (deterministic)                      │
│   tar --sort=name --mtime='UTC 2025-01-01' …    │
├──────────────────────────────────────────────────┤
│ ② 落地驗證 tar                                  │
│   tar -tvf exp42.tar > /dev/null                │
├──────────────────────────────────────────────────┤
│ ③ zstd 壓縮 (-T0 -19 --long=31)                 │
├──────────────────────────────────────────────────┤
│ ④ 立即驗證 .zst + tar header                   │
│   zstd -tq …  &&  zstd -dc … | tar -tvf -       │
├──────────────────────────────────────────────────┤
│ ⑤ 產生 SHA-256 / BLAKE3＋(可選)簽章             │
├──────────────────────────────────────────────────┤
│ ⑥ PAR2 create -r10                              │
├──────────────────────────────────────────────────┤
│ ⑦ 傳輸後再次 sha256sum -c / par2 verify         │
└──────────────────────────────────────────────────┘
```

---

### 5 具體命令清單

```bash
# 1. 建 deterministic tar
cd /data
tar --sort=name \
    --mtime='UTC 2025-01-01' \
    --owner=0 --group=0 --numeric-owner \
    -cf exp42.tar  exp42/

# 2. 驗證 tar header
tar -tvf exp42.tar > /dev/null

# 3. zstd 壓縮 (充分吃 CPU)
zstd -T0 -19 --long=31 exp42.tar -o exp42.tar.zst

# 4. 立即雙層驗證
zstd -tq exp42.tar.zst
zstd -dc exp42.tar.zst | tar -tvf - > /dev/null

# 5. 雙雜湊 + (可選) GPG 簽章
sha256sum exp42.tar.zst > exp42.tar.zst.sha256
b3sum    exp42.tar.zst > exp42.tar.zst.blake3
gpg --detach-sign --armor exp42.tar.zst.sha256   # optional

# 6. 10 % 修復冗餘
par2 create -r10 exp42.tar.zst
```

---

### 6 關鍵技術說明

#### 6.1 為什麼安裝這些套件？

* **tar 1.34+ / zstd 1.5+**：支援 `--long` 窗口與多執行緒 `-T0`。
* **par2cmdline**：提供位元級冗餘，損毀 ≤10 % 皆可修復。
* **gnupg**：用私鑰簽 `*.sha256`，建立「信任 → 雜湊 → 檔案」鏈。
* **b3sum**：BLAKE3 在多核下極快，搭配 SHA‑256 雙重保險。
* **rsync --checksum**：傳輸過程比對 128‑bit checksum，避免只看 mtime。

#### 6.2 為何使用 `--long=31` 而非 `--long`？

| 參數                | dictionary window | 釋義                                                                            |
| ----------------- | ----------------- | ----------------------------------------------------------------------------- |
| `--long` (預設 =27) | 128 MiB           | 只能抓 128 MiB 內重複片段                                                             |
| `--long=31`       | **2 GiB**         | 4–10 GB tar 可跨 GB 找重複，壓縮率再提高 3–10 %。壓縮需 ≈2.2 GB RAM，解壓需 ≈2 GB。你的 64 GB RAM 足夠 |

顯式指定數字可保證 *可重製*，且未來 zstd 改預設也不影響結果。

#### 6.3 為何先落地 `exp42.tar`，再壓縮？

**A. 分階段驗證**：tar header 可立即檢查；pipe 需等整段壓縮結束才知錯。

**B. 可重製比較**：落地 tar 便於 binary diff 與重用。

**C. 雜湊/簽章彈性**：可獨立為「未壓縮 tar」或「壓縮後 .zst」產生雜湊。

**D. PAR2 流程簡化**：修復碼只針對最終檔；若用管道，多檔 parity 腳本更複雜。

**E. 重新壓縮快速**：更改 `zstd` 參數不必重打 tar。

磁碟寫入 NVMe 對 10 GB tar 只需數秒，額外 I/O 相對整體冷備份流程可忽略。

---

> *本 SOP 聚焦於「封存產製→驗證→修復碼」的技術步驟，確保 10 年後仍可在任何安裝 7‑Zip/zstd/par2 的環境完整還原。*
